"use strict";
/*
 * Copyright (c) Huawei Technologies Co., Ltd. 2021-2021. All rights reserved.
 *
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.processUtils = void 0;
const hvigor_base_1 = require("@ohos/hvigor-base");
const cli_options_1 = require("./options/cli-options");
const init_1 = require("./lifecycle/init");
const configuration_1 = require("./lifecycle/configuration");
const execute_task_1 = require("./lifecycle/execute-task");
const default_tooling_model_bean_registry_1 = require("@ohos/hvigor-base/src/external/default-tooling-model-bean-registry");
const modeAlias = cli_options_1.cliOptions.mode.alias;
const muteStdout = require("mute-stdout");
/**
 * 用于执行具体的Gvigor的任务
 *
 * @param opts
 * @param env
 */
function processUtils(opts, env) {
    const _log = hvigor_base_1.HvigorLogger.getLogger("process-utils.js");
    // 如果执行的是sync动作,先关闭日志输出
    if (opts.sync) {
        muteStdout.mute();
    }
    // init
    (0, init_1.init)(env);
    // configure
    const project = (0, configuration_1.configuration)(env);
    const executeMode = env.configProps.get(modeAlias);
    switch (executeMode) {
        case hvigor_base_1.HvigorBuildConst.PROJECT_MODE:
            (0, execute_task_1.execute)(project, true, opts).then(outputInfo);
            break;
        case hvigor_base_1.HvigorBuildConst.MODULE_MODE:
            (0, execute_task_1.executeModuleTask)(project, opts).then(outputInfo);
            break;
        case undefined:
            (0, execute_task_1.execute)(project, false, opts);
            (0, execute_task_1.executeModuleTask)(project, opts).then(outputInfo);
            break;
        default:
            _log.error(`Unknown mode '${executeMode}' specified in command line,Please check!`);
    }
    function outputInfo() {
        // 开启打印sync的同步信息
        muteStdout.unmute();
        if (opts.sync) {
            const output = Object.create(null);
            default_tooling_model_bean_registry_1.defaultModelRegistry.getModelMap().forEach(((value, key) => {
                output[key] = value.buildModel();
            }));
            console.log(JSON.stringify(output));
        }
    }
}
exports.processUtils = processUtils;
//# sourceMappingURL=process-utils.js.map